local Players            = game:GetService("Players")
local HttpService        = game:GetService("HttpService")
local CoreGui            = game:GetService("CoreGui")
local UserInputService   = game:GetService("UserInputService")
local VirtualInputManager= game:GetService("VirtualInputManager")
local TweenService       = game:GetService("TweenService")
local RunService         = game:GetService("RunService")
local GuiService         = game:GetService("GuiService")

local LocalPlayer = Players.LocalPlayer

local TempFolder = "pngtemppp"
if makefolder and not isfolder(TempFolder) then
    makefolder(TempFolder)
end

pcall(function()
    if listfiles and delfile then
        local files = listfiles(TempFolder)
        for _, file in pairs(files) do
            delfile(file)
        end
    end
end)

local LastTempFile = nil

local PandaConfig = {
    Identifier = "nagahub", 
    FileName   = "VelvetKeypg.txt"
}

local UserID_HWID = Players.LocalPlayer.UserId 

local request_func = request or http_request or (http and http.request) or syn and syn.request
if not request_func then
    request_func = function(options)
        local response = {}
        local s, r = pcall(function()
            return HttpService:RequestAsync({
                Url     = options.Url,
                Method  = options.Method,
                Headers = options.Headers
            })
        end)
        if s then
            response.StatusCode = r.StatusCode
            response.Body       = r.Body
            response.Success    = r.Success
        else
            response.StatusCode = 500
            response.Body       = r
            response.Success    = false
        end
        return response
    end
end

local function GetKeyLink(serviceId, hwid)
    return "https://pandadevelopment.net/getkey?service=" .. tostring(serviceId) .. "&hwid=" .. tostring(hwid)
end

local function ValidateKey(key, serviceId, hwid)
    local validationUrl = "https://pandadevelopment.net/v2_validation?key=" .. tostring(key) .. "&service=" .. tostring(serviceId) .. "&hwid=" .. tostring(hwid)
    local response = request_func({ Url = validationUrl, Method = "GET" })
    
    if response and response.StatusCode == 200 then
        local s, jsonData = pcall(function() return HttpService:JSONDecode(response.Body) end)
        if s and jsonData then
            if jsonData["V2_Authentication"] == "success" then
                return true, "Authenticated"
            else
                return false, jsonData["reason"] or "Invalid Key / HWID"
            end
        else
            return false, "JSON Decode Failed"
        end
    else
        return false, "HTTP Error: " .. tostring(response and response.StatusCode or "N/A")
    end
end

local function GhostPaint_DrawDonate(color)
    local PG = LocalPlayer:FindFirstChild("PlayerGui")
    local MainUI = PG and PG:FindFirstChild("MainGameUI")
    if not MainUI then return end

    local connection
    connection = RunService.RenderStepped:Connect(function()
        local win = MainUI:FindFirstChild("ColorWindow")
        if win then
            win.Position = UDim2.new(10, 0, 10, 0) 
        end
    end)

    local function Fire(obj)
        if not obj then return end
        if getconnections then
            if obj.Activated then for _, c in pairs(getconnections(obj.Activated)) do c:Fire() end end
            if obj.MouseButton1Click then for _, c in pairs(getconnections(obj.MouseButton1Click)) do c:Fire() end end
            if obj.InputBegan then for _, c in pairs(getconnections(obj.InputBegan)) do c:Fire({UserInputType=Enum.UserInputType.Touch, UserInputState=Enum.UserInputState.Begin}) end end
        end
    end

    local function Type(box, val)
        if not box then return end
        box.Text = tostring(math.floor(val))
        if getconnections then
            for _, c in pairs(getconnections(box.FocusLost)) do c:Fire(true) end
            for _, c in pairs(getconnections(box:GetPropertyChangedSignal("Text"))) do c:Fire() end
        end
    end

    local ColorWin = MainUI:FindFirstChild("ColorWindow")
    if not ColorWin or not ColorWin.Visible then
        local OpenBtn = MainUI:FindFirstChild("Designer") 
            and MainUI.Designer:FindFirstChild("Background") 
            and MainUI.Designer.Background:FindFirstChild("Contents")
            and MainUI.Designer.Background.Contents:FindFirstChild("TopRow")
            and MainUI.Designer.Background.Contents.TopRow:FindFirstChild("Colors")
        
        if OpenBtn then
            Fire(OpenBtn)
            local s = os.clock()
            repeat 
                RunService.RenderStepped:Wait() 
                ColorWin = MainUI:FindFirstChild("ColorWindow")
                if ColorWin then ColorWin.Position = UDim2.new(10, 0, 10, 0) end
            until (ColorWin and ColorWin.Visible) or (os.clock() - s > 0.8)
        end
    end

    if not ColorWin then 
        if connection then connection:Disconnect() end
        return 
    end
    
    ColorWin.Position = UDim2.new(10, 0, 10, 0) 

    local Props = ColorWin:FindFirstChild("Properties")
    local RGB = Props and Props:FindFirstChild("RGB")
    if RGB then
        local R = RGB:FindFirstChild("R") and RGB.R:FindFirstChild("Frame") and RGB.R.Frame:FindFirstChild("TextBox")
        local G = RGB:FindFirstChild("G") and RGB.G:FindFirstChild("Frame") and RGB.G.Frame:FindFirstChild("TextBox")
        local B = RGB:FindFirstChild("B") and RGB.B:FindFirstChild("Frame") and RGB.B.Frame:FindFirstChild("TextBox")
        
        if R and G and B then
            Type(R, color.R * 255)
            Type(G, color.G * 255)
            Type(B, color.B * 255)
            RunService.RenderStepped:Wait()
        end
    end

    local ConfirmBtn = ColorWin:FindFirstChild("Content")
        and ColorWin.Content:FindFirstChild("Bottom")
        and ColorWin.Content.Bottom:FindFirstChild("Buttons")
        and ColorWin.Content.Bottom.Buttons:FindFirstChild("Confirm")
        
    if ConfirmBtn then
        Fire(ConfirmBtn)
    end

    task.delay(0.2, function()
        if connection then connection:Disconnect() end
    end)
end

local function LoadProjectVelvet()
    if getgenv().AuthGui then 
        local gui  = getgenv().AuthGui
        local main = gui:FindFirstChild("MainFrame")
        if main then
            TweenService:Create(
                main,
                TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.In),
                {Size = UDim2.new(0,0,0,0), Position = UDim2.new(0.5,0,1.5,0)}
            ):Play()
            task.wait(0.5)
        end
        gui:Destroy() 
    end 

    if getgenv().VelvetUI       then getgenv().VelvetUI:Destroy()       end
    if getgenv().FloatingBtnGui then getgenv().FloatingBtnGui:Destroy() end
    if getgenv().PreviewOverlay then getgenv().PreviewOverlay:Destroy() end

    local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

    local Config = {
        FileName       = "",
        Delay          = 0.005,
        Res            = 1,
        Scale          = 1, 
        DrawMode       = "Tap",
        IgnoreWhite    = false,
        WhiteThreshold = 230,
        IgnoreBlack    = false,
        BlackThreshold = 10,
        IgnoreAlpha    = true,
        Inverse        = false,
        TargetSize     = 150,
        Compression    = 2,
        OffsetX        = 0,
        OffsetY        = 0,
        ColorMode      = false,
        TargetGame     = "None",
        IsDrawing      = false,
        ShowPreview    = true,
        InputMethod    = "Auto" 
    }

    local CurrentImage, LastSentColor = nil, nil
    local ResSlider, ScaleSlider, StatusParagraph

    local PreviewGui = Instance.new("ScreenGui")
    PreviewGui.Name            = "PreviewOverlay"
    PreviewGui.IgnoreGuiInset  = true
    PreviewGui.ScreenInsets    = Enum.ScreenInsets.None
    PreviewGui.Enabled         = true
    PreviewGui.Parent          = CoreGui
    getgenv().PreviewOverlay   = PreviewGui

    local PreviewImage = Instance.new("ImageLabel")
    PreviewImage.Name                   = "Overlay"
    PreviewImage.BackgroundTransparency = 1
    PreviewImage.ImageTransparency      = 0.6
    PreviewImage.AnchorPoint            = Vector2.new(0, 0)
    PreviewImage.ScaleType              = Enum.ScaleType.Stretch
    PreviewImage.BorderSizePixel        = 0
    PreviewImage.Active                 = true
    PreviewImage.Parent                 = PreviewGui

    local stroke = Instance.new("UIStroke")
    stroke.Thickness        = 1
    stroke.Color            = Color3.fromRGB(255, 0, 0)
    stroke.ApplyStrokeMode  = Enum.ApplyStrokeMode.Border
    stroke.Parent           = PreviewImage

    local function GetExactBounds()
        if not CurrentImage then return 0, 0, 0, 0 end
        local Viewport = workspace.CurrentCamera.ViewportSize
        local RealW    = math.floor(CurrentImage.W / Config.Res)
        local RealH    = math.floor(CurrentImage.H / Config.Res)
        local FinalW   = math.floor(RealW * Config.Scale)
        local FinalH   = math.floor(RealH * Config.Scale)
        local CenterX  = math.floor(Viewport.X / 2)
        local CenterY  = math.floor(Viewport.Y / 2)
        local StartX   = CenterX - math.floor(FinalW / 2) + Config.OffsetX
        local StartY   = CenterY - math.floor(FinalH / 2) + Config.OffsetY
        return StartX, StartY, FinalW, FinalH
    end

    local function UpdatePreview()
        if not CurrentImage then return end
        local x, y, w, h = GetExactBounds()
        PreviewImage.Position = UDim2.fromOffset(x, y)
        PreviewImage.Size     = UDim2.fromOffset(w, h)
    end

    workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(UpdatePreview)

    local Dragging, DragStart, StartOffset = false, nil, nil

    PreviewImage.InputBegan:Connect(function(input)
        if (input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1)
            and not Config.IsDrawing then
            Dragging    = true
            DragStart   = input.Position
            StartOffset = Vector2.new(Config.OffsetX, Config.OffsetY)
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if Dragging and (input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseMovement) then
            local Delta   = input.Position - DragStart
            Config.OffsetX = math.floor(StartOffset.X + Delta.X)
            Config.OffsetY = math.floor(StartOffset.Y + Delta.Y)
            UpdatePreview()
        end
    end)

    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
            Dragging = false
        end
    end)

    local function FetchAvatar(u)
        local s, uid = pcall(function() return Players:GetUserIdFromNameAsync(u) end)
        if not s or not uid then return nil,"User not found" end
        local req = game:HttpGet("https://thumbnails.roblox.com/v1/users/avatar?userIds="..uid.."&size=420x420&format=Png&isCircular=false")
        local d   = HttpService:JSONDecode(req)
        if d and d.data[1] then
            return game:HttpGet(d.data[1].imageUrl)
        end
        return nil,"API Error"
    end

    local SprayPaint_Settings, SpeedDraw_Module = nil, nil
    local function DetectGame()
        local pg = Players.LocalPlayer:FindFirstChild("PlayerGui")
        if pg and pg:FindFirstChild("MainGameUI") then
             local mgui = pg.MainGameUI
             if mgui:FindFirstChild("Designer") or mgui:FindFirstChild("ColorWindow") then
                 Config.TargetGame = "Draw & Donate"
                 Config.ColorMode = true
                 return "Draw & Donate"
             end
        end

        if Players.LocalPlayer:FindFirstChild("PaintSettings") then
            SprayPaint_Settings = Players.LocalPlayer.PaintSettings
            Config.TargetGame   = "Spray Paint"
            Config.ColorMode    = true
            return "Spray Paint"
        end
        
        local function Scan(root)
            for _, v in pairs(root:GetDescendants()) do
                if v:IsA("ModuleScript") and v.Name == "ColorChooser" then
                    local s, m = pcall(require, v)
                    if s and m and m.SetColor then return m end
                end
            end
        end
        local ps = Players.LocalPlayer:FindFirstChild("PlayerScripts")
        SpeedDraw_Module = (pg and Scan(pg)) or (ps and Scan(ps)) or nil
        if SpeedDraw_Module then
            Config.TargetGame = "Speed Draw"
            Config.ColorMode  = true
            return "Speed Draw"
        end
        Config.ColorMode = false
        return "Monochrome"
    end
    local DetectedGameName = DetectGame()
    local GameStatusMsg    = "Mode: " .. DetectedGameName

    local function AttemptSetColor(r, g, b)
        if not Config.ColorMode then return end
        local NewColor = Color3.fromRGB(r, g, b)
        if LastSentColor == NewColor then return end
        LastSentColor = NewColor
        
        if Config.TargetGame == "Spray Paint" and SprayPaint_Settings then
            SprayPaint_Settings:SetAttribute("Color", NewColor)
        
        elseif Config.TargetGame == "Speed Draw" and SpeedDraw_Module then
            pcall(function() SpeedDraw_Module.SetColor(NewColor) end)
        
        elseif Config.TargetGame == "Draw & Donate" then
            GhostPaint_DrawDonate(NewColor)
        end
    end

    local IsTouchPlatform = UserInputService.TouchEnabled
    
    local moveAbs   = rawget(getgenv(), "mousemoveabs") or rawget(_G, "mousemoveabs")
    local mouseDown = rawget(getgenv(), "mouse1down")   or rawget(_G, "mouse1down")
    local mouseUp   = rawget(getgenv(), "mouse1up")     or rawget(_G, "mouse1up")

    local function InputTap(x:number, y:number, delay:number)
        x = math.round(x)
        y = math.round(y)

        local useMouse = false
        
        if Config.InputMethod == "MouseCustom" then
            if moveAbs then
                useMouse = true
            else
                useMouse = false
            end
        elseif Config.InputMethod == "Touch" then
            useMouse = false
        else
            if moveAbs and mouseDown and mouseUp then
                useMouse = true
            else
                useMouse = false
            end
        end

        if useMouse and moveAbs and mouseDown and mouseUp then
            moveAbs(x, y)
            mouseDown()
            if delay > 0 then task.wait(delay) end
            mouseUp()
        else
            pcall(function()
                VirtualInputManager:SendTouchEvent(1, 0, x, y) 
                task.wait() 
                VirtualInputManager:SendTouchEvent(1, 2, x, y)
            end)
        end
    end

    local PNG_Lib = nil
    pcall(function()
        local function DL(p) 
            if isfile and isfile(TempFolder.."/"..p) then
                return loadstring(readfile(TempFolder.."/"..p))()
            end
            local d = game:HttpGet("https://raw.githubusercontent.com/MaximumADHD/Roblox-PNG-Library/master/"..p)
            return loadstring(d)() 
        end
        
        local Deflate = loadstring(game:HttpGet("https://raw.githubusercontent.com/MaximumADHD/Roblox-PNG-Library/master/Modules/Deflate.lua"))()
        
        local Unfilter = {} 
        function Unfilter:None(s,b,bp,r) for i=1,#s do b[r][i]=string.byte(s,i) end end
        function Unfilter:Sub(s,b,bp,r) for i=1,#s do local x=string.byte(s,i) local a=(i>bp)and b[r][i-bp]or 0 b[r][i]=bit32.band(x+a,0xFF) end end
        function Unfilter:Up(s,b,bp,r) for i=1,#s do local x=string.byte(s,i) local bb=(r>1)and b[r-1][i]or 0 b[r][i]=bit32.band(x+bb,0xFF) end end
        function Unfilter:Average(s,b,bp,r) for i=1,#s do local x=string.byte(s,i) local a=(i>bp)and b[r][i-bp]or 0 local bb=(r>1)and b[r-1][i]or 0 b[r][i]=bit32.band(x+math.floor((a+bb)/2),0xFF) end end
        function Unfilter:Paeth(s,b,bp,r) for i=1,#s do local x=string.byte(s,i) local a=(i>bp)and b[r][i-bp]or 0 local bb=(r>1)and b[r-1][i]or 0 local c=(i>bp and r>1)and b[r-1][i-bp]or 0 local p=a+bb-c local pa,pb,pc=math.abs(p-a),math.abs(p-bb),math.abs(p-c) local pr=(pa<=pb and pa<=pc)and a or(pb<=pc)and bb or c b[r][i]=bit32.band(x+pr,0xFF) end end

        local BinaryReader = {}
        BinaryReader.__index = BinaryReader
        function BinaryReader.new(d) return setmetatable({D=d,P=1,L=#d},BinaryReader) end
        function BinaryReader:ReadByte() if self.P>self.L then return 0 end local b=string.byte(self.D,self.P) self.P=self.P+1 return b end
        function BinaryReader:ReadBytes(c) local r=string.sub(self.D,self.P,self.P+c-1) self.P=self.P+c return r end
        function BinaryReader:ReadString(l) return self:ReadBytes(l) end
        function BinaryReader:ReadInt32() local b1,b2,b3,b4=self:ReadByte(),self:ReadByte(),self:ReadByte(),self:ReadByte() return bit32.lshift(b1,24)+bit32.lshift(b2,16)+bit32.lshift(b3,8)+b4 end

        local PNG = {}
        PNG.__index = PNG
        function PNG.new(d)
            local r = BinaryReader.new(d)
            if r:ReadString(8) ~= "\137PNG\r\n\26\n" then error("Not PNG") end
            local chunks, zlib, reading = {}, {}, true
            while reading do
                local l = r:ReadInt32()
                local t = r:ReadString(4)
                if l>0 then
                    local dt = r:ReadBytes(l)
                    if t=="IDAT" then table.insert(zlib, dt) elseif t=="IHDR" then chunks.IHDR = dt end
                end
                r:ReadInt32()
                if t=="IEND" then reading=false end
            end
            local res, idx = {}, 0
            Deflate:InflateZlib({Input=BinaryReader.new(table.concat(zlib)),Output=function(b) idx=idx+1 res[idx]=string.char(b) end})
            local h_r = BinaryReader.new(chunks.IHDR)
            local w,h = h_r:ReadInt32(), h_r:ReadInt32()
            local dep = h_r:ReadByte() 
            local ct  = h_r:ReadByte() 
            
            local samples = 1
            if ct == 2 then samples = 3 
            elseif ct == 4 then samples = 2 
            elseif ct == 6 then samples = 4 
            end
            
            local bpp = math.max(1, samples * (dep/8))
            
            local file = {W=w, H=h, B=bpp, Depth=dep, ColorType=ct, Bit={}}
            local buf  = BinaryReader.new(table.concat(res))
            for row=1,h do
                local f  = buf:ReadByte()
                local sl = buf:ReadBytes(w*bpp)
                file.Bit[row] = {}
                if f==0 then Unfilter:None(sl,file.Bit,bpp,row) elseif f==1 then Unfilter:Sub(sl,file.Bit,bpp,row) elseif f==2 then Unfilter:Up(sl,file.Bit,bpp,row) elseif f==3 then Unfilter:Average(sl,file.Bit,bpp,row) elseif f==4 then Unfilter:Paeth(sl,file.Bit,bpp,row) end
            end
            return setmetatable(file, PNG)
        end
        
        function PNG:GetPixel(x,y)
            if not self.Bit[y] then return 0,0,0,0 end
            local i = (x-1)*self.B+1
            
            local function get(offset) return self.Bit[y][offset] or 0 end
            
            if self.B == 1 then 
                local g = get(i)
                return g, g, g, 255
            elseif self.B == 2 then 
                local g = get(i)
                local a = get(i+1)
                return g, g, g, a
            elseif self.B == 3 then 
                return get(i), get(i+1), get(i+2), 255
            elseif self.B == 4 then 
                return get(i), get(i+1), get(i+2), get(i+3)
            elseif self.B == 6 then 
                return get(i), get(i+2), get(i+4), 255
            elseif self.B >= 8 then 
                return get(i), get(i+2), get(i+4), get(i+6)
            end
            
            return 0,0,0,0
        end
        PNG_Lib = PNG
    end)

    local function RunAutoTune()
        if not CurrentImage then return end
        local Max = math.max(CurrentImage.W, CurrentImage.H)
        local Tgt = Config.TargetSize
        local C   = Config.Compression
        local NR, NS = 1, 1
        if Max > Tgt then NR = math.ceil(Max / Tgt) else NS = math.ceil(Tgt / Max) end
        NR = math.ceil(NR * C)
        NS = math.ceil(NS * C)
        Config.Res   = NR
        Config.Scale = NS
        if ResSlider   then ResSlider:Set(NR) end
        if ScaleSlider then ScaleSlider:Set(NS) end
        UpdatePreview()
    end

    local function ProcessLoadedImage(data, sourceName, isAsset, isManualFile)
        if not PNG_Lib then
            StatusParagraph:Set({Title = "Error", Content = "PNG Lib not loaded"})
            return
        end

        local s, res = pcall(function() return PNG_Lib.new(data) end)
        
        if s then
            CurrentImage = res
            
            if isAsset then
                pcall(function() PreviewImage.Image = getcustomasset(sourceName) end)
            elseif isManualFile then
                pcall(function() PreviewImage.Image = getcustomasset(sourceName) end)
            else
                if writefile and getcustomasset then
                    if LastTempFile and isfile(LastTempFile) then
                        delfile(LastTempFile)
                    end
                    
                    local rnd = tostring(math.random(100000, 999999))
                    local uniquePath = TempFolder .. "/img_" .. rnd .. ".png"
                    LastTempFile = uniquePath
                    
                    pcall(function()
                        writefile(uniquePath, data)
                        task.wait(0.05) 
                        PreviewImage.Image = getcustomasset(uniquePath)
                    end)
                end
            end
            
            StatusParagraph:Set({Title = "Ready", Content = "Source: " .. sourceName})
            RunAutoTune()
            Rayfield:Notify({Title="Loaded", Content="Ready to Draw!", Duration=2})
        else
            StatusParagraph:Set({Title="Error", Content="Failed to parse PNG"})
            Rayfield:Notify({Title="Error", Content="Not a valid PNG data", Duration=3})
        end
    end

    local Window = Rayfield:CreateWindow({
        Name                       = "PNG Loader - " .. DetectedGameName,
        LoadingTitle               = "Loading...",
        LoadingSubtitle            = "Please wait",
        Theme                      = "Ocean",
        ConfigurationSaving        = {Enabled=true, FolderName="PngVelvet"},
        KeySystem                  = false,
        DisableRayfieldPrompts     = true
    })

    local MainTab     = Window:CreateTab("Main", nil)
    local AutoTab     = Window:CreateTab("Auto Tune", nil)
    local FilterTab   = Window:CreateTab("Filters", nil)
    local AvatarTab   = Window:CreateTab("Avatar", nil)
    local SettingsTab = Window:CreateTab("Settings", nil)

    MainTab:CreateLabel("Press 'P' to Start Drawing")
    MainTab:CreateParagraph({
        Title = "IMPORTANT", 
        Content = "Make sure your image does NOT overlap GUI elements (Chat, Buttons, Inventory)!"
    })

    StatusParagraph = MainTab:CreateParagraph({Title = "System", Content = GameStatusMsg})

    local function GetPngFiles()
        local files    = {}
        local rawFiles = listfiles and listfiles("") or {}
        for _, path in pairs(rawFiles) do
            local fileName = path:match("([^/\\]+)$")
            if path:sub(-4):lower() == ".png" and not path:find(TempFolder) then
                table.insert(files, fileName)
            end
        end
        if #files == 0 then table.insert(files, "No PNGs found") end
        return files
    end

    local FileDropdown = MainTab:CreateDropdown({
        Name          = "Select Image (Workspace Folder Only)",
        Options       = GetPngFiles(),
        CurrentOption = "",
        Callback      = function(O) 
            local val = (type(O) == "table" and O[1]) or O
            Config.FileName = val
            if Config.FileName ~= "No PNGs found" and readfile then
                ProcessLoadedImage(readfile(Config.FileName), Config.FileName, false, true)
            end
        end
    })

    MainTab:CreateButton({
        Name     = "Refresh List",
        Callback = function() FileDropdown:Refresh(GetPngFiles(), true) end
    })

    MainTab:CreateSection("URL Loader")
    local UrlInput = ""
    MainTab:CreateInput({
        Name = "Image Link (Raw PNG Only)",
        PlaceholderText = "https://...",
        RemoveTextAfterFocusLost = false,
        Callback = function(t) UrlInput = t end
    })

    MainTab:CreateButton({
        Name = "Load from URL",
        Callback = function()
            if UrlInput ~= "" then
                Rayfield:Notify({Title="Downloading", Content="Please wait...", Duration=1})
                local s, data = pcall(function() return game:HttpGet(UrlInput) end)
                if s and data then
                    ProcessLoadedImage(data, "URL Image", false, false)
                else
                    Rayfield:Notify({Title="Error", Content="Invalid URL or Not PNG", Duration=3})
                end
            end
        end
    })

    AutoTab:CreateSlider({Name="Target Size (Px)", Range={50,800}, Increment=10, CurrentValue=150, Callback=function(V) Config.TargetSize=V RunAutoTune() end})
    AutoTab:CreateSlider({Name="Compression Level", Range={1,5}, Increment=0.5, CurrentValue=Config.Compression, Callback=function(V) Config.Compression=V RunAutoTune() end})

    FilterTab:CreateToggle({Name="Inverse Colors", CurrentValue=false, Callback=function(V) Config.Inverse=V end})
    FilterTab:CreateToggle({Name="Ignore Alpha", CurrentValue=true, Callback=function(V) Config.IgnoreAlpha=V end})
    FilterTab:CreateToggle({Name="Ignore White", CurrentValue=false, Callback=function(V) Config.IgnoreWhite=V end})
    FilterTab:CreateSlider({Name="White Threshold", Range={150,255}, Increment=1, CurrentValue=230, Callback=function(V) Config.WhiteThreshold=V end})
    FilterTab:CreateToggle({Name="Ignore Black", CurrentValue=false, Callback=function(V) Config.IgnoreBlack=V end})
    FilterTab:CreateSlider({Name="Black Threshold", Range={0,100}, Increment=1, CurrentValue=10, Callback=function(V) Config.BlackThreshold=V end})

    local AvatarUser = ""
    local AvatarInput = AvatarTab:CreateInput({
        Name                     = "Username",
        PlaceholderText          = "RobloxUser",
        RemoveTextAfterFocusLost = false,
        Callback                 = function(T) AvatarUser = T end
    })

    local function GetPlayerList()
        local pList = {}
        for _,p in pairs(Players:GetPlayers()) do table.insert(pList,p.Name) end
        return pList
    end

    local PlayerDrop = AvatarTab:CreateDropdown({
        Name          = "Select Server Player",
        Options       = GetPlayerList(),
        CurrentOption = "",
        Callback      = function(O) 
             local val = (type(O) == "table" and O[1]) or O
             AvatarUser = val
             AvatarInput:Set(AvatarUser) 
        end
    })

    AvatarTab:CreateButton({Name = "Refresh Player List", Callback = function() PlayerDrop:Refresh(GetPlayerList(), true) end})

    AvatarTab:CreateButton({
        Name     = "Load Avatar",
        Callback = function()
            if AvatarUser ~= "" then
                Rayfield:Notify({Title="Fetching", Content="Getting Avatar...", Duration=1})
                local d,e = FetchAvatar(AvatarUser)
                if d then 
                    ProcessLoadedImage(d, AvatarUser, false, false) 
                else 
                    Rayfield:Notify({Title="Error", Content=e or "Unknown"}) 
                end
            end
        end
    })

    ResSlider=SettingsTab:CreateSlider({Name="Shrink (Res)", Range={1,100}, Increment=1, CurrentValue=1, Callback=function(V) Config.Res=V UpdatePreview() end})
    ScaleSlider=SettingsTab:CreateSlider({Name="Expand (Scale)", Range={1,100}, Increment=1, CurrentValue=1, Callback=function(V) Config.Scale=V UpdatePreview() end})
    SettingsTab:CreateSlider({Name="Delay (s)", Range={0,0.1}, Increment=0.001, CurrentValue=0.005, Callback=function(V) Config.Delay=V end})
    
    SettingsTab:CreateDropdown({
        Name = "Input Method", 
        Options = {"Auto","Touch","MouseCustom"}, 
        CurrentOption = "Auto", 
        Callback = function(O) 
            local val = (type(O) == "table" and O[1]) or O
            Config.InputMethod = val
            print("Input Method Set To:", val)
        end
    })

    local function ToggleDrawing()
        Config.IsDrawing = not Config.IsDrawing

        if getgenv().FloatingBtnGui then 
            local btn = getgenv().FloatingBtnGui.Frame.TextButton 
            btn.Text  = Config.IsDrawing and "STOP" or "DRAW" 
            btn.BackgroundColor3 = Config.IsDrawing and Color3.fromRGB(231,76,60) or Color3.fromRGB(46,204,113)
            btn.Parent.Draggable = not Config.IsDrawing 
        end

        if Config.IsDrawing then
            if Config.ShowPreview then PreviewGui.Enabled = false end
            
            local StartX, StartY, _, _ = GetExactBounds()
            LastSentColor = nil

            task.spawn(function()
                for y = 1, CurrentImage.H, Config.Res do
                    if not Config.IsDrawing then break end
                    if y % 20 == 0 then RunService.Heartbeat:Wait() end

                    for x = 1, CurrentImage.W, Config.Res do
                        if not Config.IsDrawing then break end

                        local r, g, b, a = CurrentImage:GetPixel(x, y)
                        if Config.Inverse then r,g,b = 255-r, 255-g, 255-b end

                        local shouldDraw = true
                        if Config.IgnoreAlpha and a < 10 then shouldDraw = false end
                        if Config.IgnoreWhite and r > Config.WhiteThreshold and g > Config.WhiteThreshold and b > Config.WhiteThreshold then shouldDraw = false end
                        if Config.IgnoreBlack and r < Config.BlackThreshold and g < Config.BlackThreshold and b < Config.BlackThreshold then shouldDraw = false end

                        local stepX = math.floor((x-1) / Config.Res)
                        local stepY = math.floor((y-1) / Config.Res)
                        local DrawX = StartX + math.floor(stepX * Config.Scale)
                        local DrawY = StartY + math.floor(stepY * Config.Scale)

                        if shouldDraw then
                            if Config.ColorMode then AttemptSetColor(r, g, b) end
                            InputTap(DrawX, DrawY, Config.Delay)
                            if Config.Delay > 0 then task.wait(Config.Delay) end
                        end
                    end
                end

                Config.IsDrawing = false
                if Config.ShowPreview and CurrentImage then PreviewGui.Enabled = true end
                
                if getgenv().FloatingBtnGui then 
                    local btn = getgenv().FloatingBtnGui.Frame.TextButton 
                    btn.Text  = "DRAW" 
                    btn.BackgroundColor3 = Color3.fromRGB(46,204,113) 
                    btn.Parent.Draggable = true 
                end
            end)
        else
            if Config.ShowPreview and CurrentImage then PreviewGui.Enabled = true end
        end
    end

    if IsTouchPlatform then
        local FloatingGui = Instance.new("ScreenGui")
        FloatingGui.Name           = "FloatingBtnGui"
        FloatingGui.IgnoreGuiInset = true 
        FloatingGui.Parent         = CoreGui
        getgenv().FloatingBtnGui   = FloatingGui

        local FloatFrame = Instance.new("Frame")
        FloatFrame.Size                = UDim2.new(0,60,0,60)
        FloatFrame.Position            = UDim2.new(0.9,0,0.5,0)
        FloatFrame.BackgroundTransparency = 1
        FloatFrame.Active              = true
        FloatFrame.Draggable           = true
        FloatFrame.Parent              = FloatingGui

        local FloatBtn = Instance.new("TextButton")
        FloatBtn.Size              = UDim2.new(1,0,1,0)
        FloatBtn.BackgroundColor3  = Color3.fromRGB(46,204,113)
        FloatBtn.Text              = "DRAW"
        FloatBtn.TextColor3        = Color3.new(1,1,1)
        FloatBtn.Font              = Enum.Font.GothamBold
        FloatBtn.TextSize          = 14
        FloatBtn.Parent            = FloatFrame

        Instance.new("UICorner", FloatBtn).CornerRadius = UDim.new(1,0)
        Instance.new("UIStroke", FloatBtn).Thickness = 2

        local LastClickTime = 0
        FloatBtn.MouseButton1Click:Connect(function() 
            local Now = tick()
            if Now - LastClickTime < 0.5 then return end
            LastClickTime = Now
            ToggleDrawing()
        end)
    end

    UserInputService.InputBegan:Connect(function(i,g)
        if not g and i.KeyCode == Enum.KeyCode.P then ToggleDrawing() end
    end)

    task.spawn(function()
        task.wait(1)
        local url = "https://raw.githubusercontent.com/Artem1093z/ScriptsGo/main/discord.png"
        local ok, data = pcall(function() return game:HttpGet(url) end)
        if ok and data then ProcessLoadedImage(data, "GitHub discord.png", false, false) end
    end)
end

if getgenv().AuthGui then getgenv().AuthGui:Destroy() end

local AuthGui = Instance.new("ScreenGui")
AuthGui.Name          = "AuthGui"
AuthGui.Parent        = CoreGui
AuthGui.IgnoreGuiInset= true
getgenv().AuthGui     = AuthGui

local Asset_Glow = "rbxassetid://5028857472"

local MainFrame = Instance.new("Frame", AuthGui)
MainFrame.Name                   = "MainFrame"
MainFrame.Size                   = UDim2.new(0, 260, 0, 380)
MainFrame.Position               = UDim2.new(0.5, -130, 0.5, -190)
MainFrame.BackgroundColor3       = Color3.fromRGB(20, 10, 30)
MainFrame.BorderSizePixel        = 0
MainFrame.ClipsDescendants       = true
MainFrame.ZIndex                 = 2
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 24)

local BgGradient = Instance.new("UIGradient", MainFrame)
BgGradient.Color = ColorSequence.new{ColorSequenceKeypoint.new(0,Color3.fromRGB(160,32,240)),ColorSequenceKeypoint.new(0.5,Color3.fromRGB(128,0,128)),ColorSequenceKeypoint.new(1,Color3.fromRGB(75,0,130))}
BgGradient.Rotation = 45
TweenService:Create(BgGradient,TweenInfo.new(3,Enum.EasingStyle.Sine,Enum.EasingDirection.InOut,-1,true),{Rotation=90}):Play()

local GlassStroke = Instance.new("UIStroke", MainFrame)
GlassStroke.Thickness, GlassStroke.Color, GlassStroke.Transparency = 3, Color3.fromRGB(200,100,255), 0.5

local TopShine = Instance.new("ImageLabel", MainFrame)
TopShine.Size, TopShine.BackgroundTransparency, TopShine.Image = UDim2.new(1,0,0.5,0), 1, Asset_Glow
TopShine.ImageColor3, TopShine.ImageTransparency = Color3.fromRGB(255,200,255), 0.6
Instance.new("UICorner", TopShine).CornerRadius = UDim.new(0, 24)

local BubbleContainer = Instance.new("Frame", MainFrame)
BubbleContainer.Size, BubbleContainer.BackgroundTransparency, BubbleContainer.ZIndex = UDim2.new(1,0,1,0), 1, 3
task.spawn(function()
    while AuthGui.Parent do
        local bubble = Instance.new("Frame", BubbleContainer)
        local size = math.random(5, 15)
        bubble.Size, bubble.Position = UDim2.new(0,size,0,size), UDim2.new(math.random(),0,1.1,0)
        bubble.BackgroundColor3, bubble.BackgroundTransparency = Color3.fromRGB(220,150,255), 0.6
        Instance.new("UICorner", bubble).CornerRadius = UDim.new(1, 0)
        TweenService:Create(bubble,TweenInfo.new(math.random(2,5),Enum.EasingStyle.Quad,Enum.EasingDirection.Out),{Position=UDim2.new(bubble.Position.X.Scale,math.random(-30,30),-0.1,0),BackgroundTransparency=1}):Play()
        game.Debris:AddItem(bubble, 6)
        task.wait(math.random(0.1, 0.5))
    end
end)

local Content = Instance.new("Frame", MainFrame)
Content.Size, Content.Position, Content.BackgroundTransparency, Content.ZIndex = UDim2.new(1,-30,1,-30), UDim2.new(0,15,0,15), 1, 10

local TitleBox = Instance.new("Frame", Content)
TitleBox.Size, TitleBox.BackgroundTransparency = UDim2.new(1,0,0,60), 1

local Title = Instance.new("TextLabel", TitleBox)
Title.Text, Title.Font, Title.TextSize = "PNG Loader", Enum.Font.GothamBlack, 32
Title.Size, Title.BackgroundTransparency, Title.TextColor3, Title.ZIndex = UDim2.new(1,0,0.7,0), 1, Color3.fromRGB(255,255,255), 12
local TStroke = Instance.new("UIStroke", Title)
TStroke.Thickness, TStroke.Color, TStroke.Transparency = 3, Color3.fromRGB(80,0,120), 0.2

local Sub = Instance.new("TextLabel", TitleBox)
Sub.Text, Sub.Font, Sub.TextSize, Sub.Position = "SECURITY SYSTEM", Enum.Font.GothamBold, 10, UDim2.new(0,0,0.65,0)
Sub.Size, Sub.BackgroundTransparency, Sub.TextColor3, Sub.ZIndex = UDim2.new(1,0,0.3,0), 1, Color3.fromRGB(230,200,255), 12

local Orb = Instance.new("ImageLabel", Content)
Orb.Size, Orb.Position, Orb.BackgroundTransparency, Orb.Image = UDim2.new(0,70,0,70), UDim2.new(0.5,-35,0.25,0), 1, "rbxassetid://3570695787"
Orb.ImageColor3, Orb.ImageTransparency, Orb.ZIndex = Color3.fromRGB(200,100,255), 0.8, 10
local InnerOrb = Instance.new("Frame", Orb)
InnerOrb.Size, InnerOrb.Position, InnerOrb.BackgroundColor3, InnerOrb.BackgroundTransparency = UDim2.new(0.6,0,0.6,0), UDim2.new(0.2,0,0.2,0), Color3.fromRGB(255,255,255), 0.5
Instance.new("UICorner", InnerOrb).CornerRadius = UDim.new(1,0)
TweenService:Create(InnerOrb,TweenInfo.new(2,Enum.EasingStyle.Sine,Enum.EasingDirection.InOut,-1,true),{BackgroundTransparency=0.8}):Play()

local InputBg = Instance.new("Frame", Content)
InputBg.Size, InputBg.Position, InputBg.BackgroundColor3, InputBg.BackgroundTransparency = UDim2.new(1,0,0,40), UDim2.new(0,0,0.52,0), Color3.fromRGB(30,0,60), 0.6
InputBg.ZIndex = 11
Instance.new("UICorner", InputBg).CornerRadius = UDim.new(1,0)
local IS = Instance.new("UIStroke", InputBg)
IS.Color, IS.Transparency, IS.Thickness = Color3.fromRGB(150,80,200), 0.5, 1

local KeyBox = Instance.new("TextBox", InputBg)
KeyBox.Size, KeyBox.Position, KeyBox.BackgroundTransparency = UDim2.new(1,-20,1,0), UDim2.new(0,10,0,0), 1
KeyBox.Font, KeyBox.TextSize, KeyBox.TextColor3 = Enum.Font.Gotham, 14, Color3.fromRGB(255,255,255)
KeyBox.PlaceholderText, KeyBox.PlaceholderColor3, KeyBox.ZIndex = "Paste Key Here...", Color3.fromRGB(180,140,200), 12

local function CreateButton(text, yPos, colorA, colorB, callback)
    local Btn = Instance.new("TextButton", Content)
    Btn.Size, Btn.Position, Btn.BackgroundColor3, Btn.Text = UDim2.new(1,0,0,38), UDim2.new(0,0,yPos,0), Color3.fromRGB(255,255,255), ""
    Btn.AutoButtonColor, Btn.ZIndex = false, 15
    Instance.new("UICorner", Btn).CornerRadius = UDim.new(0,12)
    local Grad = Instance.new("UIGradient", Btn)
    Grad.Color, Grad.Rotation = ColorSequence.new(colorA,colorB), 90
    local InnerStroke = Instance.new("UIStroke", Btn)
    InnerStroke.ApplyStrokeMode, InnerStroke.Color, InnerStroke.Transparency, InnerStroke.Thickness = Enum.ApplyStrokeMode.Border, Color3.fromRGB(255,255,255), 0.3, 2
    local Lbl = Instance.new("TextLabel", Btn)
    Lbl.Size, Lbl.BackgroundTransparency, Lbl.Text, Lbl.Font, Lbl.TextSize = UDim2.new(1,0,1,0), 1, text, Enum.Font.GothamBold, 13
    Lbl.TextColor3, Lbl.ZIndex = Color3.fromRGB(255,255,255), 16
    local TS = Instance.new("UIStroke", Lbl)
    TS.Thickness, TS.Color, TS.Transparency = 1, Color3.fromRGB(50,0,50), 0.8
    Btn.MouseButton1Click:Connect(function() 
        local F = Instance.new("Frame", Btn)
        F.Size, F.BackgroundColor3, F.BackgroundTransparency = UDim2.new(1,0,1,0), Color3.fromRGB(255,255,255), 0.5
        Instance.new("UICorner",F).CornerRadius = UDim.new(0,12)
        TweenService:Create(F,TweenInfo.new(0.3),{BackgroundTransparency=1}):Play()
        game.Debris:AddItem(F,0.3)
        if callback then callback() end
    end)
    return Btn, Lbl
end

local CheckBtn, CheckLbl = CreateButton("Login", 0.68, Color3.fromRGB(180,50,220), Color3.fromRGB(100,0,150), nil)
local LinkBtn, LinkLbl = CreateButton("Get Key", 0.81, Color3.fromRGB(80,150,240), Color3.fromRGB(40,80,180), function()
    setclipboard(GetKeyLink(PandaConfig.Identifier, UserID_HWID))
    if LinkLbl then LinkLbl.Text = "Copied!" task.wait(1) LinkLbl.Text = "Get Key" end
end)

local Status = Instance.new("TextLabel", Content)
Status.Size, Status.Position, Status.BackgroundTransparency, Status.Text = UDim2.new(1,0,0,20), UDim2.new(0,0,0.94,0), 1, "Waiting..."
Status.Font, Status.TextSize, Status.TextColor3, Status.ZIndex = Enum.Font.Gotham, 11, Color3.fromRGB(220,200,255), 15

local DraggingAuth, DragStartAuth, StartPosAuth
MainFrame.InputBegan:Connect(function(input) if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then DraggingAuth = true DragStartAuth = input.Position StartPosAuth = MainFrame.Position end end)
UserInputService.InputChanged:Connect(function(input) if DraggingAuth and (input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseMovement) then local Delta = input.Position - DragStartAuth MainFrame.Position = UDim2.new(StartPosAuth.X.Scale, StartPosAuth.X.Offset + Delta.X, StartPosAuth.Y.Scale, StartPosAuth.Y.Offset + Delta.Y) end end)
UserInputService.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then DraggingAuth = false end end)

local SavedKey = ""
if isfile and isfile(PandaConfig.FileName) then SavedKey = readfile(PandaConfig.FileName) KeyBox.Text = SavedKey end

CheckBtn.MouseButton1Click:Connect(function()
    Status.Text, Status.TextColor3 = "Authenticating...", Color3.fromRGB(255,255,100)
    local isValid, msg = ValidateKey(KeyBox.Text:gsub(" ", ""), PandaConfig.Identifier, UserID_HWID)
    if isValid then
        Status.Text, Status.TextColor3 = "Success!", Color3.fromRGB(255,255,255)
        if writefile then writefile(PandaConfig.FileName, KeyBox.Text:gsub(" ", "")) end
        LoadProjectVelvet()
    else
        Status.Text, Status.TextColor3 = msg, Color3.fromRGB(255,100,100)
    end
end)
